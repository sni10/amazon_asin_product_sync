@startuml

skinparam shadowing false
skinparam packageStyle rectangle
skinparam classAttributeIconVisibility false
skinparam classAttributeIconSize 0

' Пакет конфигурации и ядра
package "App Kernel" {
  class App {
    - containerInstance: ContainerInterface
    + setContainer(ContainerInterface): void
    + getContainer(): ContainerInterface
    + getEntityManager(): EntityManagerInterface
  }

  class Kernel {
  }
}

package "Entities" {
  class AmazonCredentials {
    -id: int
    -clientId: string
    -clientSecret: string
    -refreshToken: string
    -proxy: string
    -marketplaceId: string
    +getId(): int
    +getClientId(): string
    +getClientSecret(): string
    +getRefreshToken(): string
    +getProxy(): string
    +getMarketplaceId(): string
  }

  class AmazonProducts {
    -id: int
    -upc: string
    -payload: array
    -asin: string
    -asinParent: string
    -createdAt: datetime
    -updatedAt: datetime
  }

  class Companies {
    -id: int
    -name: string
  }

  class ProductsIdentification {
    -id: int
    -sourceCompanyId: int
    -productSourceCompanyId: int
    -targetCompanyId: int
    -productTargetCompanyId: int
    -coincidences: int
    -createdAt: datetime
    -updatedAt: datetime
  }

  class ProductsIdentificationHistory {
    -id: int
    -sourceCompanyId: int
    -productSourceCompanyId: int
    -targetCompanyId: int
    -productTargetCompanyId: int
    -coincidences: int
    -createdAt: datetime
    -updatedAt: datetime
  }

  class Proxy {
    -id: int
    -proxy: string
    -groupId: int
    -lastStartAt: datetime
    -retryCount: int
    -lastHttpStatus: int
    -pausedUntil: datetime
  }

  class WalmartProducts {
    -id: int
    -walmartId: int
    -upc: string
    -title: string
    -brand: string
    -specification: string
    -groupUuid: string
    -createdAt: datetime
    -updatedAt: datetime
  }

}

package "Repositories" {
  class AmazonCredentialsRepository {
  }
  
  class AmazonProductsRepository {
    +saveAmazonProduct(?string, string, string, array): int
    +getProductsByUpc(string): array
  }
  
  class CompaniesRepository {
    +getAllCompanies(): array
  }

  class ProductsIdentificationRepository {
    +saveProductIdentification(int,int,int,int,int): int
    +saveProductIdentificationHistory(int,int,int,int,int): int
    +getProductsByPeriod(string,string): array
  }

  class ProxyRepository {
    +getAvailable(int,int): array
    +increaseRate(string)
    +updateLastStartAt(int)
  }

  class WalmartProductsRepository {
    +getWalmartProducts(int,int,int): mixed
    +getWalmartProductsArrayByBrandFilter(int,int,int): array
    +getWalmartProductsArray(int,int,int): array
    +getWalmartProductsIdentified(int,int,int): array
    +getProductsByGroupId(string,array): array
    +updateProductDate(int): int
    +getProductsByPeriod(string,string): array
  }
}

package "Services" {
  class AmazonService {
    -em: EntityManagerInterface
    -connection: SellerConnector
    -clientId: string
    -clientSecret: string
    -refreshToken: string
    -proxy: string
    -marketplaceId: string
    +connectSellingPartnerApi(string,string,string,string,string): void
    +getAmazonProducts(array,string): array
    +setCurrentProcessNumber(int): void
  }

  class IdentifyWalmart {
    -em: EntityManagerInterface
    -proxy: Proxy (service)
    -amazonService: AmazonService
    -companies: array
    +init(int,int): self
    +indentify(): int
    +reidentify(int,int): void
  }

  class MappingController {
    +checkSizeMapping(string,string,int): int
    +checkColorMapping(string,string,int): int
    +checkBrandMapping(string,string,int): int
  }

  class MappingDatabase {
    +getSizeMapping(): array
    +getColorMapping(): array
    +replaceBrandMappingNew(): array
  }

  class ProductCoincidenseTrait {
    +coincidencesStatus(array,array): (int,int)
  }

  class ProxyService {
    -repository: ProxyRepository
    +getNext(): Proxy
    +setSuccess(Proxy): self
    +setFail(Proxy,string): self
    +saveState(): self
  }

  class StatisticsService {
    +sendStatistics()
  }
}

package "Commands" {
  class IdentifyCrossVariationsCommand {
  }

  class IdentifyIdentifiedCommand {
  }

  class SendStatisticToSlackCommand {
  }

  class CheckAmazonAPICommand {
  }

  class CheckMappingCommand {
  }
}

' Связи Entity <-> Repository
AmazonCredentialsRepository --> AmazonCredentials
AmazonProductsRepository --> AmazonProducts
CompaniesRepository --> Companies
ProductsIdentificationRepository --> ProductsIdentification
ProductsIdentificationRepository --> ProductsIdentificationHistory
ProxyRepository --> Proxy
WalmartProductsRepository --> WalmartProducts

' Сервисы и их зависимости
IdentifyWalmart --> AmazonService
IdentifyWalmart --> ProxyService
IdentifyWalmart --> ProductsIdentificationRepository
IdentifyWalmart --> WalmartProductsRepository
IdentifyWalmart --> CompaniesRepository

AmazonService --> EntityManagerInterface

StatisticsService --> ProductsIdentificationRepository
StatisticsService --> WalmartProductsRepository

ProxyService --> ProxyRepository
ProxyService --> Proxy

' Команды и их зависимости
IdentifyCrossVariationsCommand --> EntityManagerInterface
IdentifyCrossVariationsCommand --> IdentifyWalmart

IdentifyIdentifiedCommand --> EntityManagerInterface
IdentifyIdentifiedCommand --> IdentifyWalmart

SendStatisticToSlackCommand --> EntityManagerInterface
SendStatisticToSlackCommand --> StatisticsService

CheckAmazonAPICommand --> AmazonService
CheckAmazonAPICommand --> EntityManagerInterface

CheckMappingCommand --> EntityManagerInterface

App --> Kernel
App --> ContainerInterface
App --> EntityManagerInterface

@enduml
